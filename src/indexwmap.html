<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <meta charset="UTF-8">
  <title>Equal Video Feeds with Console</title>
  <style>
    body {
      margin: 0;
      background: black;
      color: white;
      font-family: monospace;
      height: 100vh;
      overflow: hidden;
    }
    .container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 15vh;
      display: flex;
    }
    .feed {
      flex: 1 1 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: black;
      position: relative;
    }
    .label {
      position: absolute;
      top: 5px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 14px;
      background: rgba(0,0,0,0.5);
      padding: 2px 6px;
      border-radius: 4px;
    }
    .console {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 15vh;
      min-height: 60px;
      background: #111;
      padding: 5px;
      overflow-y: auto;
      resize: vertical;
      border-top: 3px solid #555;
      box-sizing: border-box;
    }
    .mini {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 120px;
      height: 90px;
      border: 2px solid white;
      cursor: pointer;
      z-index: 10;
      background: black;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .mini img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body>

<div class="container" id="feed-container">
  <div class="feed" id="map-feed" style="display:none;">
    <div class="label">MAP feed</div>
    <div id="map" style="width:100%; height:100%;"></div>
  </div>  

  <div class="mini" id="mini-map" onclick="showMap()"></div>

  <div class="feed" id="rgb-feed">
    <div class="label">RGB feed</div>
    <img id="rgb-img" src="/rgb_feed" alt="RGB feed" />
  </div>

  <div class="feed" id="ir-feed">
    <div class="label">IR feed</div>
    <img id="ir-img" src="/ir_feed" alt="IR feed" />
  </div>
</div>

<div class="console" id="console"></div>

<script>
  const feedContainer = document.getElementById("feed-container");
  const rgbFeed = document.getElementById("rgb-feed");
  const irFeed = document.getElementById("ir-feed");
  const mini = document.getElementById("mini-map");
  const mapFeed = document.getElementById("map-feed");

  let miniMap = null;
  let mainMap = null;
  let droneMarker = null;
  let trackLine = null;
  let trackLatLngs = [];

  function droneIconHtml(heading) {
    const svg = `
      <svg viewBox="-12 -12 24 24" width="24" height="24" xmlns="http://www.w3.org/2000/svg">
        <g transform="rotate(${heading || 0})">
          <path d="M0 -8 L4 6 L0 3 L-4 6 Z" fill="#00ff66" stroke="#003300" stroke-width="0.4"/>
        </g>
      </svg>`;
    return L.divIcon({ className: 'drone-icon', html: svg, iconSize: [24, 24], iconAnchor: [12, 12] });
  }

  function initMiniMap(center = [38.9897, -76.9378], zoom = 13) {
    if (miniMap) return;
    mini.innerHTML = "";
    const div = document.createElement("div");
    div.style.width = "100%";
    div.style.height = "100%";
    mini.appendChild(div);

    miniMap = L.map(div, {
      zoomControl: false,
      attributionControl: false,
      dragging: false,
      scrollWheelZoom: false,
      doubleClickZoom: false,
      boxZoom: false
    }).setView(center, zoom);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(miniMap);
  }

  function initMainMap(center = [38.9897, -76.9378], zoom = 13) {
    if (mainMap) return;
    mainMap = L.map('map', { zoomControl: true }).setView(center, zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(mainMap);

    droneMarker = L.marker(center, { icon: droneIconHtml(0) }).addTo(mainMap);
    trackLine = L.polyline([], { color: 'yellow', weight: 3, opacity: 0.9 }).addTo(mainMap);
  }

  function updateMapFromPosition(pos) {
    if (!pos) return;
    const lat = pos.air_lat;
    const lon = pos.air_lon;
    const heading = pos.heading;
    if (lat != null && lon != null) {
      const latlng = [lat, lon];
      trackLatLngs.push(latlng);
      if (trackLatLngs.length > 200) trackLatLngs.shift();

      if (mainMap && droneMarker) {
        droneMarker.setLatLng(latlng);
        droneMarker.setIcon(droneIconHtml(heading || 0));
        trackLine.setLatLngs(trackLatLngs);
      }

      if (miniMap) {
        if (!mini._drone) {
          mini._drone = L.marker(latlng, {
            icon: L.divIcon({
              className: '',
              html: '<div style="width:8px;height:8px;border-radius:50%;background:#7fff7f;border:1px solid #033"></div>',
              iconSize: [8, 8],
              iconAnchor: [4, 4]
            })
          }).addTo(miniMap);
        } else {
          mini._drone.setLatLng(latlng);
        }
      }
    }
  }

  function showMap() {
    irFeed.style.display = "none";
    rgbFeed.style.display = "none";
    mapFeed.style.display = "flex";
    mapFeed.style.flex = "1 1 100%";
    initMainMap();
    setTimeout(() => mainMap.invalidateSize && mainMap.invalidateSize(), 200);
    showMiniImage("/rgb_feed");
  }

  function showDual() {
    mapFeed.style.display = "none";
    irFeed.style.display = "flex";
    rgbFeed.style.display = "flex";
    rgbFeed.style.flex = "1 1 50%";
    irFeed.style.flex = "1 1 50%";
    initMiniMap();
    showMiniMap();
  }

  function showMiniImage(src) {
    mini.innerHTML = "";
    const img = document.createElement("img");
    img.src = src;
    img.style.width = "100%";
    img.style.height = "100%";
    img.style.objectFit = "cover";
    mini.appendChild(img);
    mini.onclick = showDual;
  }

  function showMiniMap() {
    initMiniMap();
    mini.onclick = showMap;
  }

  initMiniMap();
  showMiniMap();
</script>

<script>
  let lastPosition = null;

  async function fetchMapPosition() {
    try {
      const res = await fetch("/status_text");
      if (!res.ok) return;
      const data = await res.json();
      const pos = data.position;
      if (pos && (!lastPosition || pos.air_lat !== lastPosition.air_lat || pos.air_lon !== lastPosition.air_lon)) {
        updateMapFromPosition(pos);
        lastPosition = pos;
      }
    } catch (err) {
      console.warn("⚠️ Map position fetch failed", err);
    }
  }

  setInterval(fetchMapPosition, 1000);
  fetchMapPosition();
</script>

<script>
  const consoleDiv = document.getElementById("console");

  function logToConsole(text) {
    const line = document.createElement("div");
    line.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
    consoleDiv.appendChild(line);
    consoleDiv.scrollTop = consoleDiv.scrollHeight;
  }

  let lastConsoleText = "";

  async function fetchConsoleStatus() {
    try {
      const response = await fetch("/status_text");
      if (!response.ok) return;

      const data = await response.json();
      const currentText = data.text;
      if (currentText && currentText !== lastConsoleText) {
        logToConsole(currentText);
        lastConsoleText = currentText;
      }
    } catch (err) {
      logToConsole("No console to log");
    }
  }

  setInterval(fetchConsoleStatus, 1000);
  fetchConsoleStatus();
</script>

</body>
</html>